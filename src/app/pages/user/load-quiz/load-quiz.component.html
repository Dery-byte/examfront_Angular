<!-- ══ PAGE HEADER ═══════════════════════════════════════════════ -->
<div class="page-header" *ngIf="!isLoadingReports">
  <div class="page-header-row">
    <div>
      <div class="page-kicker">Student Dashboard</div>
      <h1 class="page-title">Quiz Summary</h1>
      <p class="page-sub">Review your exam performance and results</p>
    </div>
    <div class="page-badge" *ngIf="reports.length > 0">
      <span class="badge-dot"></span>
      {{ reports.length }} quiz{{ reports.length !== 1 ? 'zes' : '' }} taken
    </div>
  </div>

  <!-- Stats strip — only when we have data -->
  <div class="stats-strip" *ngIf="reports.length > 0">
    <div class="ss-item">
      <div class="ss-val">{{ reports.length }}</div>
      <div class="ss-lbl">Total Quizzes</div>
      <div class="ss-note">all courses</div>
    </div>
    <div class="ss-item">
      <div class="ss-val">{{ getClosedCount() }}</div>
      <div class="ss-lbl">Completed</div>
      <div class="ss-note">results ready</div>
    </div>
    <div class="ss-item">
      <div class="ss-val">{{ reports.length - getClosedCount() }}</div>
      <div class="ss-lbl">Active</div>
      <div class="ss-note">in progress</div>
    </div>
    <div class="ss-item">
      <div class="ss-val">{{ getAvgScore() }}%</div>
      <div class="ss-lbl">Avg. Score</div>
      <div class="ss-note">completed only</div>
    </div>
  </div>
</div>

<!-- ══ LOADING — full page ═══════════════════════════════════════ -->
<div *ngIf="isLoadingReports" class="loading-full">
  <div class="spinner"></div>
  <div class="loading-title">Loading Your Courses…</div>
  <div class="loading-note">Preparing your learning dashboard</div>
</div>

<!-- ══ NO HISTORY ════════════════════════════════════════════════ -->
<div *ngIf="!isLoadingReports && reports.length === 0" class="no-history">
  <div class="nh-icon">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
      <rect x="9" y="3" width="6" height="4" rx="1"/>
      <line x1="9" y1="12" x2="15" y2="12"/>
      <line x1="9" y1="16" x2="12" y2="16"/>
    </svg>
  </div>
  <h2 class="nh-title">No Quiz History</h2>
  <p class="nh-body">You haven't taken any quizzes yet. Check your courses for available exams.</p>
  <button class="nh-btn" routerLink="/user-dashboard/register">
    Browse Courses
    <svg class="arr" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <path d="M5 12h14M12 5l7 7-7 7"/>
    </svg>
  </button>
</div>

<!-- ══ MAIN DASHBOARD ═════════════════════════════════════════════ -->
<div *ngIf="!isLoadingReports && reports.length > 0" class="dash-layout">

  <!-- ── Course selector ── -->
  <div class="panel sel-panel">

    <div class="sel-head">
      <div class="sel-kicker">Filter by course</div>
      <div class="sel-title">Select Course</div>
    </div>

    <div class="sel-body">
      <!-- Dropdown -->
      <div class="field-wrap">
        <div class="field-shell">
          <span class="fs-icon">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7" rx="1"/>
              <rect x="14" y="3" width="7" height="7" rx="1"/>
              <rect x="3" y="14" width="7" height="7" rx="1"/>
              <rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
          </span>
          <select name="category"
            [(ngModel)]="selectedCategoryId"
            (change)="onQuizOptionSelected()">
            <option value="">All courses</option>
            <option *ngFor="let c of uniqueCategories" [value]="c.cid">
              {{ c.courseCode }} : {{ c.title }}
            </option>
          </select>
          <span class="field-arrow">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </span>
        </div>
      </div>

      <!-- Course quick-list -->
      <div class="course-list">
        <div class="ci"
          *ngFor="let c of uniqueCategories"
          [class.active]="selectedCategoryId === c.cid"
          (click)="selectedCategoryId = c.cid; onQuizOptionSelected()">
          <span class="ci-dot"></span>
          <div>
            <span class="ci-name">{{ c.title }}</span>
            <span class="ci-code">{{ c.courseCode }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Selector footer -->
    <div class="sel-stats">
      <div class="ss2-item">
        <div class="ss2-val">{{ reports.length }}</div>
        <div class="ss2-lbl">Total</div>
      </div>
      <div class="ss2-item">
        <div class="ss2-val">{{ getClosedCount() }}</div>
        <div class="ss2-lbl">Done</div>
      </div>
      <div class="ss2-item">
        <div class="ss2-val">{{ reports.length - getClosedCount() }}</div>
        <div class="ss2-lbl">Live</div>
      </div>
    </div>

  </div><!-- /sel-panel -->

  <!-- ── Quiz cards column ── -->
  <div class="quizzes-col panel">

    <!-- Inline loading -->
    <div *ngIf="isLoadingQuizzes" class="inline-loading">
      <div class="spinner"></div>
      <span class="inline-loading-txt">Loading quiz data…</span>
    </div>

    <!-- Empty for selected course -->
    <div *ngIf="!isLoadingQuizzes && availablequizzes && availablequizzes.length === 0"
         class="empty-inner">
      <svg class="empty-inner-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.3">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        <line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/>
      </svg>
      <div class="empty-inner-title">No Quizzes Found</div>
      <div class="empty-inner-sub">Select a different course or check back later</div>
    </div>

    <!-- Quiz grid -->
    <div class="quiz-grid"
         *ngIf="!isLoadingQuizzes && availablequizzes && availablequizzes.length > 0">

      <div class="qc"
           *ngFor="let q of availablequizzes; let i = index"
           [class.qc-closed]="q.status === 'CLOSED'">

        <div class="qc-body">
          <div class="qc-meta">
            <span class="status-chip"
              [ngClass]="q.status === 'CLOSED' ? 'chip-closed' : 'chip-active'">
              <span class="chip-dot"></span>
              {{ q.status === 'CLOSED' ? 'Completed' : 'Active' }}
            </span>
            <span class="qc-idx">#{{ (i + 1).toString().padStart(3, '0') }}</span>
          </div>
          <div class="qc-title">{{ q.title }}</div>
          <div class="qc-course">{{ q.category.courseCode }} · {{ q.category.title }}</div>
          <div class="qc-desc">{{ q.description || 'No description available' }}</div>
        </div>

        <div class="qc-foot">
          <!-- Summary -->
          <button class="btn btn-ghost" (click)="openNew(q.qId)">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            Summary
          </button>

          <!-- Print -->
          <button class="btn"
            [ngClass]="q.status === 'CLOSED' ? 'btn-lime' : 'btn-muted'"
            [disabled]="q.status !== 'CLOSED'"
            (click)="onPrintClick($event, q.qId)">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 6 2 18 2 18 9"/>
              <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
              <rect x="6" y="14" width="12" height="8"/>
            </svg>
            Print
          </button>
        </div>

        <!-- Lock notice -->
        <div *ngIf="q.status !== 'CLOSED'" class="print-notice">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          <span>Print unlocks after quiz closure</span>
        </div>

      </div><!-- /qc -->
    </div><!-- /quiz-grid -->

  </div><!-- /quizzes-col -->

</div><!-- /dash-layout -->


<!-- ══ DIALOG (replaces p-dialog) ════════════════════════════════ -->
<div class="dlg-backdrop"
     [class.open]="productDialog"
     (click)="handleDlgBackdrop($event)">
  <div class="dlg-box">

    <div class="dlg-head">
      <div class="dlg-head-left">
        <div class="dlg-tag">
          <span class="dlg-tag-dot"></span>
          Performance
        </div>
        <div class="dlg-title">Quiz Performance Summary</div>
      </div>
      <button class="dlg-close" (click)="productDialog = false">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="dlg-body">

      <!-- Results table -->
      <table class="res-table" *ngIf="reportData && reportData.length > 0">
        <thead>
          <tr>
            <th>Quiz Title</th>
            <th *ngIf="showObjectiveColumn()">Objective</th>
            <th *ngIf="showTheoryColumn()">Theory</th>
            <th>Total</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of reportData">
            <td class="td-title">{{ r.quiz.title }}</td>
            <td *ngIf="showObjectiveColumn()" class="td-score">
              <strong>{{ r.marks }}</strong>/{{ r.quiz.maxMarks }}
            </td>
            <td *ngIf="showTheoryColumn()" class="td-score">
              <strong>{{ r.marksB }}</strong>/{{ r.maxScoreSectionB }}
            </td>
            <td class="td-score">
              <strong>{{ getTotalMarks(r) }}</strong>/{{ getTotalMaxMarks(r) }}
            </td>
            <td>
              <span class="status-sm"
                [ngClass]="r.progress === 'Completed' ? 'sm-done' : 'sm-pend'">
                {{ r.progress }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- No data -->
      <div *ngIf="!reportData || reportData.length === 0" class="dlg-empty">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.3">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <div class="dlg-empty-title">No Results Available</div>
        <div class="dlg-empty-sub">Complete a quiz to view performance data</div>
      </div>

    </div><!-- /dlg-body -->
  </div><!-- /dlg-box -->
</div><!-- /dlg-backdrop -->